# Prompt para Desenvolvimento de Aplicativo .NET MAUI - Sistema de Autenticação NAuth

## Visão Geral do Projeto
Desenvolva um aplicativo móvel multiplataforma usando .NET MAUI (.NET 8) que implemente um sistema completo de autenticação de usuários utilizando o projeto NAuth.ACL como biblioteca de integração com a API de autenticação.

## Arquitetura e Tecnologias

### Tecnologias Obrigatórias
- .NET MAUI (.NET 8)
- C# 12.0
- MVVM Pattern (Model-View-ViewModel)
- Dependency Injection
- Community Toolkit MVVM
- NAuth.ACL (biblioteca existente para integração com API)
- NAuth.DTO (objetos de transferência de dados)

### Estrutura do Projeto
```
NAuth.Maui/
├── Views/               # Páginas XAML
├── ViewModels/          # ViewModels com lógica de negócio
├── Models/              # Modelos locais
├── Services/            # Serviços da aplicação
├── Helpers/             # Classes auxiliares
├── Resources/           # Recursos (imagens, estilos, etc)
└── MauiProgram.cs       # Configuração e DI
```

## Funcionalidades Requeridas

### 1. Tela de Login
**Funcionalidades:**
- Campo de entrada para e-mail (com validação de formato)
- Campo de entrada para senha (com opção de mostrar/ocultar)
- Botão "Entrar" para realizar login
- Link "Esqueci minha senha" que redireciona para recuperação
- Link "Criar conta" que redireciona para cadastro
- Indicador de carregamento durante autenticação
- Persistência de sessão (lembrar login)
- Tratamento de erros com mensagens amigáveis

**Integração NAuth.ACL:**
```csharp
// Usar IUserClient.LoginWithEmailAsync(LoginParam param)
var loginParam = new LoginParam 
{ 
    Email = email, 
    Password = password 
};
var userInfo = await _userClient.LoginWithEmailAsync(loginParam);
```

**Validações:**
- E-mail: formato válido
- Senha: não vazio
- Feedback visual de campos inválidos

### 2. Tela de Cadastro de Usuário
**Funcionalidades:**
- Campo: Nome completo (obrigatório)
- Campo: E-mail (obrigatório, validação de formato)
- Campo: Senha (obrigatório, mínimo 8 caracteres)
- Campo: Confirmar senha (deve ser igual à senha)
- Campo: Data de nascimento (opcional, DatePicker)
- Campo: CPF/Documento (opcional, com máscara)
- Botão "Cadastrar"
- Link "Já tenho conta" para voltar ao login
- Indicador de carregamento
- Feedback de sucesso/erro

**Integração NAuth.ACL:**
```csharp
// Usar IUserClient.InsertAsync(UserInfo user)
var newUser = new UserInfo
{
    Name = name,
    Email = email,
    Password = password,
    BirthDate = birthDate,
    IdDocument = cpf,
    Status = 1 // Ativo
};
var result = await _userClient.InsertAsync(newUser);
```

**Validações:**
- Nome: não vazio, mínimo 3 caracteres
- E-mail: formato válido, não cadastrado
- Senha: mínimo 8 caracteres, letras e números
- Confirmar senha: igual à senha
- CPF: formato válido (opcional)

### 3. Tela de Recuperação de Senha
**Funcionalidades:**
- Campo de entrada para e-mail
- Botão "Enviar e-mail de recuperação"
- Mensagem de confirmação após envio
- Link "Voltar ao login"
- Indicador de carregamento
- Tratamento de erros

**Integração NAuth.ACL:**
```csharp
// Usar IUserClient.SendRecoveryMailAsync(string email)
var success = await _userClient.SendRecoveryMailAsync(email);
```

**Validações:**
- E-mail: formato válido e cadastrado

### 4. Tela de Redefinição de Senha (via Hash)
**Funcionalidades:**
- Campo: Nova senha
- Campo: Confirmar nova senha
- Botão "Redefinir senha"
- Recebe hash de recuperação via deep link ou parâmetro
- Feedback de sucesso/erro
- Redirecionamento automático para login após sucesso

**Integração NAuth.ACL:**
```csharp
// Usar IUserClient.ChangePasswordUsingHashAsync(ChangePasswordUsingHashParam param)
var changeParam = new ChangePasswordUsingHashParam
{
    RecoveryHash = recoveryHash,
    NewPassword = newPassword
};
var success = await _userClient.ChangePasswordUsingHashAsync(changeParam);
```

### 5. Tela de Troca de Senha (Usuário Logado)
**Funcionalidades:**
- Campo: Senha atual
- Campo: Nova senha
- Campo: Confirmar nova senha
- Botão "Alterar senha"
- Validação se usuário possui senha cadastrada
- Feedback de sucesso/erro

**Integração NAuth.ACL:**
```csharp
// Verificar se tem senha: IUserClient.HasPasswordAsync(string token)
var hasPassword = await _userClient.HasPasswordAsync(token);

// Alterar senha: IUserClient.ChangePasswordAsync(ChangePasswordParam param, string token)
var changeParam = new ChangePasswordParam
{
    OldPassword = oldPassword,
    NewPassword = newPassword
};
var success = await _userClient.ChangePasswordAsync(changeParam, token);
```

### 6. Tela Principal (Após Login)
**Funcionalidades:**
- Exibir informações do usuário logado (nome, e-mail, foto)
- Botão para acessar perfil do usuário
- Botão para alterar senha
- Botão para logout
- Menu de navegação

**Integração NAuth.ACL:**
```csharp
// Obter dados do usuário: IUserClient.GetMeAsync(string token)
var userInfo = await _userClient.GetMeAsync(token);
```

### 7. Tela de Perfil do Usuário
**Funcionalidades:**
- Exibir e editar: Nome, E-mail, Data de nascimento, CPF
- Upload de foto de perfil
- Botão "Salvar alterações"
- Feedback de sucesso/erro

**Integração NAuth.ACL:**
```csharp
// Atualizar usuário: IUserClient.UpdateAsync(UserInfo user, string token)
var updatedUser = await _userClient.UpdateAsync(userInfo, token);

// Upload de imagem: IUserClient.UploadImageUserAsync(Stream fileStream, string fileName, string token)
var imageUrl = await _userClient.UploadImageUserAsync(stream, fileName, token);
```

## Serviços Necessários

### AuthService
```csharp
public interface IAuthService
{
    Task<UserInfo> LoginAsync(string email, string password);
    Task LogoutAsync();
    Task<bool> IsAuthenticatedAsync();
    Task<string> GetTokenAsync();
    Task SaveTokenAsync(string token);
    Task<UserInfo> GetCurrentUserAsync();
}
```

### UserService
```csharp
public interface IUserService
{
    Task<UserInfo> RegisterAsync(UserInfo user);
    Task<UserInfo> UpdateProfileAsync(UserInfo user);
    Task<bool> ChangePasswordAsync(string oldPassword, string newPassword);
    Task<bool> SendPasswordRecoveryAsync(string email);
    Task<bool> ResetPasswordAsync(string hash, string newPassword);
    Task<string> UploadProfileImageAsync(Stream imageStream, string fileName);
}
```

## Configuração do NAuth.ACL no MAUI

### MauiProgram.cs
```csharp
public static class MauiProgram
{
    public static MauiApp CreateMauiApp()
    {
        var builder = MauiApp.CreateBuilder();
        builder
            .UseMauiApp<App>()
            .ConfigureFonts(fonts =>
            {
                fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
                fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
            });

        // Configurar HttpClient
        builder.Services.AddHttpClient();

        // Configurar NAuth Settings
        builder.Services.Configure<NAuthSetting>(options =>
        {
            options.ApiUrl = "https://sua-api-url.com/api"; // Configurar URL da API
        });

        // Registrar NAuth.ACL UserClient
        builder.Services.AddScoped<IUserClient, UserClient>();

        // Registrar serviços da aplicação
        builder.Services.AddSingleton<IAuthService, AuthService>();
        builder.Services.AddSingleton<IUserService, UserService>();

        // Registrar ViewModels
        builder.Services.AddTransient<LoginViewModel>();
        builder.Services.AddTransient<RegisterViewModel>();
        builder.Services.AddTransient<ForgotPasswordViewModel>();
        builder.Services.AddTransient<ResetPasswordViewModel>();
        builder.Services.AddTransient<ChangePasswordViewModel>();
        builder.Services.AddTransient<ProfileViewModel>();
        builder.Services.AddTransient<MainViewModel>();

        // Registrar Views
        builder.Services.AddTransient<LoginPage>();
        builder.Services.AddTransient<RegisterPage>();
        builder.Services.AddTransient<ForgotPasswordPage>();
        builder.Services.AddTransient<ResetPasswordPage>();
        builder.Services.AddTransient<ChangePasswordPage>();
        builder.Services.AddTransient<ProfilePage>();
        builder.Services.AddTransient<MainPage>();

        return builder.Build();
    }
}
```

## Gerenciamento de Estado e Navegação

### Token e Sessão
- Armazenar token JWT usando SecureStorage do MAUI
- Implementar refresh token se disponível
- Verificar validade do token ao iniciar app
- Redirecionar para login se token inválido/expirado

### Navegação
- Shell navigation para navegação entre páginas
- AppShell.xaml para definir estrutura de navegação
- Roteamento com parâmetros para deep linking

## Design e UX

### Princípios de Design
- Interface limpa e intuitiva
- Cores consistentes com identidade visual
- Feedback visual para todas as ações
- Indicadores de carregamento (ActivityIndicator)
- Mensagens de erro/sucesso amigáveis (Toast/Alert)
- Validação em tempo real dos campos
- Acessibilidade (labels, contraste, tamanho de fonte)

### Componentes Visuais
- Entry com borda arredondada
- Buttons com estilo consistente
- Labels para feedback de validação
- ActivityIndicator para loading
- Frame/Border para agrupamento visual
- ScrollView para telas longas

## Tratamento de Erros

### Estratégias
- Try-catch em todas as chamadas assíncronas
- Log de erros (Debug.WriteLine ou logger)
- Mensagens amigáveis ao usuário
- Retry logic para falhas de rede
- Timeout configurável para requisições HTTP

### Tipos de Erro
- Erro de rede (sem conexão)
- Erro de autenticação (credenciais inválidas)
- Erro de validação (dados inválidos)
- Erro do servidor (500)
- Timeout de requisição

## Segurança

### Práticas de Segurança
- Nunca armazenar senha em texto plano
- Usar SecureStorage para tokens
- Validar entrada do usuário (prevenir injection)
- HTTPS obrigatório para todas as requisições
- Timeout de sessão configurável
- Logout automático após inatividade

## Testes

### Testes Recomendados
- Testes unitários dos ViewModels
- Testes de integração com NAuth.ACL
- Testes de UI (opcional)
- Testes de fluxo completo (login -> ações -> logout)

## Configurações Adicionais

### appsettings.json ou configuração
```json
{
  "NAuthSetting": {
    "ApiUrl": "https://sua-api-url.com/api"
  },
  "SessionTimeout": 3600,
  "EnableRememberMe": true
}
```

### Permissions (Android/iOS)
- INTERNET (Android)
- Camera (para foto de perfil)
- Storage (para foto de perfil)

## Bibliotecas NuGet Recomendadas
- CommunityToolkit.Mvvm (MVVM helpers)
- CommunityToolkit.Maui (controles adicionais)
- Microsoft.Extensions.Http (HttpClient)
- Microsoft.Extensions.Options (configurações)
- Newtonsoft.Json ou System.Text.Json (serialização)

## Entregáveis Esperados
1. Projeto .NET MAUI completo e funcional
2. Integração total com NAuth.ACL
3. Todas as telas especificadas implementadas
4. Navegação fluida entre telas
5. Tratamento de erros robusto
6. Validações de entrada implementadas
7. Design responsivo e atraente
8. Documentação básica (README.md)
9. Código limpo e comentado
10. Testes básicos implementados

## Fluxo de Navegação

```
[Splash Screen]
       |
       v
[Verificar Autenticação]
       |
       +--> Não autenticado --> [Login Page]
       |                             |
       |                             +--> Esqueci senha --> [Forgot Password Page]
       |                             |                            |
       |                             |                            v
       |                             |                      [Email enviado] --> [Login Page]
       |                             |
       |                             +--> Criar conta --> [Register Page] --> [Login Page]
       |                             |
       |                             v
       |                        [Autenticado]
       |                             |
       +--> Já autenticado ----------+
                                     |
                                     v
                              [Main Page]
                                     |
                                     +--> Perfil --> [Profile Page]
                                     |                      |
                                     |                      v
                                     |              [Upload foto/Editar dados]
                                     |
                                     +--> Alterar senha --> [Change Password Page]
                                     |
                                     +--> Logout --> [Login Page]
```

## Observações Importantes
1. O projeto NAuth.ACL já existe e deve ser referenciado como dependência
2. O NAuth.DTO contém todas as classes necessárias (UserInfo, LoginParam, etc.)
3. A API NAuth já está implementada e funcional
4. O aplicativo deve ser multiplataforma (Android e iOS no mínimo)
5. Seguir padrões de código .NET e boas práticas MAUI
6. Implementar injeção de dependência corretamente
7. O token retornado no login deve ser usado em todas as requisições autenticadas
8. Implementar deep linking para recuperação de senha via e-mail

## Exemplos de Código

### ViewModel Base
```csharp
public abstract class BaseViewModel : ObservableObject
{
    private bool _isBusy;
    public bool IsBusy
    {
        get => _isBusy;
        set => SetProperty(ref _isBusy, value);
    }

    protected async Task ExecuteAsync(Func<Task> operation)
    {
        if (IsBusy) return;
        
        try
        {
            IsBusy = true;
            await operation();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error: {ex.Message}");
            await ShowErrorAsync(ex.Message);
        }
        finally
        {
            IsBusy = false;
        }
    }

    protected virtual Task ShowErrorAsync(string message)
    {
        return Application.Current.MainPage.DisplayAlert("Erro", message, "OK");
    }

    protected virtual Task ShowSuccessAsync(string message)
    {
        return Application.Current.MainPage.DisplayAlert("Sucesso", message, "OK");
    }
}
```

### LoginViewModel Exemplo
```csharp
public partial class LoginViewModel : BaseViewModel
{
    private readonly IAuthService _authService;
    
    [ObservableProperty]
    private string _email;
    
    [ObservableProperty]
    private string _password;

    public LoginViewModel(IAuthService authService)
    {
        _authService = authService;
    }

    [RelayCommand]
    private async Task LoginAsync()
    {
        await ExecuteAsync(async () =>
        {
            if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
            {
                await ShowErrorAsync("Preencha todos os campos");
                return;
            }

            var user = await _authService.LoginAsync(Email, Password);
            if (user != null)
            {
                await Shell.Current.GoToAsync("//MainPage");
            }
        });
    }

    [RelayCommand]
    private async Task NavigateToRegisterAsync()
    {
        await Shell.Current.GoToAsync("RegisterPage");
    }

    [RelayCommand]
    private async Task NavigateToForgotPasswordAsync()
    {
        await Shell.Current.GoToAsync("ForgotPasswordPage");
    }
}
```

## Prioridades de Implementação
1. **Fase 1 (MVP):**
   - Tela de Login
   - Integração com NAuth.ACL
   - Armazenamento de token
   - Tela principal básica

2. **Fase 2:**
   - Cadastro de usuário
   - Recuperação de senha
   - Perfil do usuário

3. **Fase 3:**
   - Troca de senha
   - Upload de foto
   - Melhorias de UX
   - Tratamento de erros avançado

## Conclusão
Este prompt descreve um aplicativo completo de autenticação usando .NET MAUI integrado com o sistema NAuth existente. O aplicativo deve ser robusto, seguro e proporcionar uma excelente experiência ao usuário, seguindo as melhores práticas de desenvolvimento mobile e padrões do .NET MAUI.
